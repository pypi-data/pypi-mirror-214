#!/usr/bin/env bash

# variables
MAESTRO_DIR="$PWD"

VENV_DIR="$MAESTRO_DIR/.venv"

BIN_DIR="$HOME/bin"

CONFIG_DIR="$HOME/.config/maestro"
CONFIG_FILE="$CONFIG_DIR/maestro.yaml"
DEFAULT_CONFIG_FILE="$MAESTRO_DIR/maestro/maestro_template.yaml"

MAESTRO_SERVER_EXE="$BIN_DIR/maestroserver" 
MAESTRO_CLIENT_EXE="$BIN_DIR/maestro" 

DESKTOP_FILE_DIR="$HOME/.local/share/applications"
ICONS_DIR="$HOME/.local/share/icons"

# install maestro
echo "create virtual environment at $VENV_DIR"
python3 -m venv $VENV_DIR
source $VENV_DIR/bin/activate

echo 'upgrade pip'
python3 -m pip install --upgrade pip

echo 'install required packages'
python3 -m pip install --pre kivy
python3 -m pip install pyyaml python-vlc python-mpv
python3 -m pip install -e .

echo 'put application in path'
mkdir -p $BIN_DIR
cat > $MAESTRO_SERVER_EXE <<- EOM
#!/usr/bin/env bash
source $VENV_DIR/bin/activate
python3 $MAESTRO_DIR/maestro/server.py "\$@"
EOM
chmod +x $MAESTRO_SERVER_EXE
cat > $MAESTRO_CLIENT_EXE <<- EOM
#!/usr/bin/env bash
source $VENV_DIR/bin/activate
python3 $MAESTRO_DIR/maestro/client.py "\$@"
EOM
chmod +x $MAESTRO_CLIENT_EXE

echo 'make default config'
mkdir -p $CONFIG_DIR
if [ ! -f $CONFIG_FILE ]; then
    cp $DEFAULT_CONFIG_FILE $CONFIG_FILE 
fi

echo 'install icon file'
mkdir -p $ICONS_DIR
icondest="$ICONS_DIR/maestro.svg"
if [ ! -f $icondest ]; then
    cp "$MAESTRO_DIR/icons/maestro.svg" $icondest 
fi

echo 'add desktop entry'
desktop-file-install --dir=$DESKTOP_FILE_DIR ./maestro.desktop
update-desktop-database $DESKTOP_FILE_DIR
