//- No Comment --- Comment any resource on the web!
//- Copyright © 2023 Bioneland
//-
//- This program is free software: you can redistribute it and/or modify
//- it under the terms of the GNU Affero General Public License as
//- published by the Free Software Foundation, either version 3 of the
//- License, or (at your option) any later version.
//-
//- This program is distributed in the hope that it will be useful,
//- but WITHOUT ANY WARRANTY; without even the implied warranty of
//- MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
//- GNU Affero General Public License for more details.
//-
//- You should have received a copy of the GNU Affero General Public License
//- along with this program. If not, see <http://www.gnu.org/licenses/>.

extends layout

block content
  section.section
    .container
      figure.image.is-32x32.is-pulled-right
        a(href="#{url_for('comments.index', stream_id=stream_id, format='atom')}")
          img(width="32" src="#{url_for('static', filename='img/feed.svg')}" alt="Feed")

      h1.title.is-1 A stream

  section.section
    .container
      h2.title.is-2 Add a comment on…

      #form
        block form
          form(
            method="POST"
            action=""
            hx-post=""
            hx-target="#form"
          )
            .field
              label.label(for="url") URL
              .control
                input.input(
                  type="url"
                  id="url"
                  name="url"
                  value="#{url}"
                  placeholder="The URL of the resource to comment"
                )
            .field
              label.label(for="text") Text
              .control
                textarea.textarea(type="text" id="text" name="text" value="")
            .field.is-expended
              .control
                button.button.is-link.is-fullwidth(_="on click add .is-loading")
                  | Comment

            if comment_id
              article.message.is-success
                .message-body Comment added!

            if error
              article.message.is-danger
                .message-body= error

  section.section
    .container
      h2.title.is-3 Past comments

      block comments
        #comments.comments(hx-get="" hx-trigger="commentAdded from:body")
          mixin comment_content(comment)
              .card-content
                pre.text= comment.text
                p
                  a.url(href=comment.url)= comment.url
                  br
                  time.date(datetime=comment.created)= comment.created

          each comment in comments
            if loop.last
              .comment.card.mb-2(
                hx-get=next_page_url
                hx-trigger="revealed"
                hx-swap="beforeend"
                hx-target="#comments"
                hx-indicator="#indicator"
              )
                +comment_content(comment)
            else
              .comment.card.mb-2
                +comment_content(comment)

      #indicator.buttons.is-centered.mt-3.htmx-indicator.is-hidden(_="on load remove .is-hidden")
          button.button.is-white.is-loading Loading indicator

      if previous_page_url or next_page_url:
        .buttons.is-centered.mt-3(_="on load remove me")
          if previous_page_url:
            a#previous-page.button.is-link(href="#{previous_page_url}")
              span Previous
          if next_page_url:
            a#next-page.button.is-link(href="#{next_page_url}")
              span Next
