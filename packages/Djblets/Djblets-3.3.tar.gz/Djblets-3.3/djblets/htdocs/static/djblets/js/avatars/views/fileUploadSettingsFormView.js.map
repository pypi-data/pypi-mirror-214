{"version":3,"file":"fileUploadSettingsFormView.js","names":["allowedMimeTypes","ParentView","Djblets","Avatars","ServiceSettingsFormView","FileUploadSettingsFormView","extend","events","validate","file","_$fileInput","files","alert","gettext","some","el","type","render","_$box","$","_$preview","_onBrowseClicked","e","preventDefault","stopPropagation","click","_onDragEnter","target","width","addClass","_onDragOver","dt","originalEvent","dataTransfer","dropEffect","_onDragLeave","removeClass","_onDrop","length","fileType","exc","_setAvatarFromFile","_onFileChanged","reader","FileReader","addEventListener","empty","append","attr","src","result","alt","readAsDataURL"],"sources":["../../../../../../static/djblets/js/avatars/views/fileUploadSettingsFormView.es6.js"],"sourcesContent":["(function() {\n\n\nconst allowedMimeTypes = [\n    'image/png', 'image/jpeg', 'image/gif'\n];\n\n\nconst ParentView = Djblets.Avatars.ServiceSettingsFormView;\n\n\n/**\n * A file upload avatar settings form.\n *\n * This form provides a preview of the uploaded avatar.\n */\nDjblets.Avatars.FileUploadSettingsFormView = ParentView.extend({\n    events: {\n        'change #id_file-upload-avatar_upload': '_onFileChanged',\n        'click .avatar-file-upload-browse': '_onBrowseClicked',\n        'click .avatar-preview': '_onBrowseClicked',\n        'dragenter .avatar-file-upload-config': '_onDragEnter',\n        'dragover .avatar-file-upload-config': '_onDragOver',\n        'dragleave .avatar-file-upload-config': '_onDragLeave',\n        'drop .avatar-file-upload-config': '_onDrop',\n    },\n\n    /**\n     * Validate the form.\n     *\n     * If a file is selected, ensure it is has the correct MIME type.\n     */\n    validate() {\n        const file = this._$fileInput[0].files[0];\n\n        if (!file) {\n            alert(_`You must choose a file.`);\n            return false;\n        }\n\n        if (!allowedMimeTypes.some(el => (el === file.type))) {\n            alert(_`\n                This wasn't a valid image file format. Please provide a PNG,\n                JPEG, or GIF file.\n            `);\n            return false;\n        }\n\n        return true;\n    },\n\n    /**\n     * Render the form.\n     *\n     * Returns:\n     *     Djblets.Avatars.FileUploadSettingsFormView:\n     *     This view (for chaining).\n     */\n    render() {\n        this._$box = this.$('.avatar-file-upload-config');\n        this._$preview = this.$('.avatar-preview');\n        this._$fileInput = this.$('#id_file-upload-avatar_upload');\n\n        return this;\n    },\n\n    /**\n     * Handler for a click event on the \"browse\" instruction text.\n     *\n     * This will trigger opening the hidden file input.\n     *\n     * Args:\n     *     e (jQuery.Event):\n     *         The click event.\n     */\n    _onBrowseClicked(e) {\n        e.preventDefault();\n        e.stopPropagation();\n\n        /*\n         * Clicking on the file input itself is not reliable. There are ways\n         * to make it work, but the browser actively avoids letting you do it if\n         * it seems to be hidden. However, it works just fine universally to\n         * click on the label.\n         */\n        this.$('#avatar-file-upload-browse-label').click();\n    },\n\n    /**\n     * Handler for a drag enter event.\n     *\n     * If the configuration box is being hovered over, this will enable the\n     * hover state, giving users an indication that they can drop the image\n     * there.\n     *\n     * Args:\n     *     e (jQuery.Event):\n     *         The drag over event.\n     */\n    _onDragEnter(e) {\n        e.preventDefault();\n        e.stopPropagation();\n\n        if (e.target === this._$box[0]) {\n            this._$box\n                .width(this._$box.width())\n                .addClass('drag-hover');\n        }\n    },\n\n    /**\n     * Handler for a drag over event.\n     *\n     * If the configuration box is being hovered over, this will set the drop\n     * effect.\n     *\n     * Args:\n     *     e (jQuery.Event):\n     *         The drag over event.\n     */\n    _onDragOver(e) {\n        e.preventDefault();\n        e.stopPropagation();\n\n        if (e.target === this._$box[0]) {\n            const dt = e.originalEvent.dataTransfer;\n\n            if (dt) {\n                dt.dropEffect = 'copy';\n            }\n        }\n    },\n\n    /**\n     * Handler for a drag leave event.\n     *\n     * If the configuration box is being left, this will remove the hover state\n     * and reset the drop effect.\n     *\n     * Args:\n     *     e (jQuery.Event):\n     *         The drag leave event.\n     */\n    _onDragLeave(e) {\n        e.preventDefault();\n        e.stopPropagation();\n\n        if (e.target === this._$box[0]) {\n            this._$box\n                .removeClass('drag-hover')\n                .width('auto');\n\n            const dt = e.originalEvent.dataTransfer;\n\n            if (dt) {\n                dt.dropEffect = 'none';\n            }\n        }\n    },\n\n    /**\n     * Handler for a drop operation.\n     *\n     * This will remove the hover state and attempt to set the list of files\n     * on the file input. If this fails (which will be the case on some browsers\n     * with older behavior), the user will receive an alert telling them it\n     * failed and to try browsing instead.\n     *\n     * If all goes well, the avatar will be ready for upload and the preview\n     * image will be updated.\n     *\n     * Args:\n     *     e (jQuery.Event):\n     *         The drop event.\n     */\n    _onDrop(e) {\n        e.preventDefault();\n        e.stopPropagation();\n\n        this._$box.removeClass('drag-hover');\n\n        const dt = e.originalEvent.dataTransfer;\n        const files = dt && dt.files;\n\n        if (!files || files.length === 0) {\n            return;\n        }\n\n        if (files.length > 1) {\n            alert(_`\n                You can only set one file as your avatar. Please drag and\n                drop a single file.\n            `);\n            return;\n        }\n\n        const fileType = files[0].type;\n\n        if (fileType !== 'image/png' && fileType !== 'image/jpeg' &&\n            fileType !== 'image/gif') {\n            alert(_`\n                This doesn't appear to be a compatible image file for avatars.\n                Please upload a PNG, JPEG, or GIF file.\n            `);\n            return;\n        }\n\n        try {\n            this._$fileInput[0].files = files;\n        } catch (exc) {\n            /*\n             * While most modern browsers allow setting the `files` property of\n             * an input field to the rest of a drag-and-drop operation, not all\n             * do (I'm looking at you, IE/Edge). Older browsers will also\n             * complain. So instead of outright failing, tell the user that this\n             * won't work and suggest a workaround.\n             */\n            alert(_`\n                Looks like dragging to upload a file isn't going to work with\n                your browser. Try browsing for a file instead.\n            `);\n            return;\n        }\n\n        this._setAvatarFromFile(files[0]);\n    },\n\n    /**\n     * Handler for when the file input has changed.\n     *\n     * This will update the preview image.\n     *\n     * Args:\n     *     e (jQuery.Event):\n     *         The change event.\n     */\n    _onFileChanged(e) {\n        const file = e.target.files[0];\n\n        if (file) {\n            this._setAvatarFromFile(file);\n        }\n    },\n\n    /**\n     * Set the avatar from the provided file upload.\n     *\n     * Args:\n     *     file (File):\n     *         The file that was uploaded.\n     */\n    _setAvatarFromFile(file) {\n        const reader = new FileReader();\n\n        reader.addEventListener('load', () => {\n            this._$preview\n                .empty()\n                .removeClass('avatar-preview-unset')\n                .append($('<img />').attr({\n                     src: reader.result,\n                     alt: _`Your new avatar`,\n                 }));\n        });\n\n        reader.readAsDataURL(file);\n    },\n});\n\n\n})();\n"],"mappings":"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"}